{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://trace-inject.local/config.schema.json",
  "title": "TraceInject Configuration",
  "description": "Configuration schema for the TraceInject trace injection system",
  "type": "object",
  "properties": {
    "parser": {
      "type": "object",
      "description": "Parser configuration options",
      "properties": {
        "isModule": {
          "type": "boolean",
          "description": "Whether to parse as a module (true) or script (false)",
          "default": true
        },
        "isTypeScript": {
          "type": "boolean",
          "description": "Whether to parse TypeScript",
          "default": true
        },
        "hasJSX": {
          "type": "boolean",
          "description": "Whether to parse JSX/TSX syntax",
          "default": true
        },
        "filename": {
          "type": "string",
          "description": "Source filename for better error messages"
        },
        "sourceMap": {
          "type": "boolean",
          "description": "Whether to attach source map information",
          "default": true
        },
        "includeSourceMap": {
          "type": "boolean",
          "description": "Whether to include source maps in parsed output"
        },
        "sourceFilename": {
          "type": "string",
          "description": "Custom filename for better error messages"
        }
      },
      "additionalProperties": false
    },
    "capture": {
      "$ref": "#/definitions/captureConfig"
    },
    "tracepoints": {
      "type": "array",
      "description": "List of tracepoints to inject",
      "items": {
        "$ref": "#/definitions/tracepointDefinition"
      },
      "minItems": 1
    },
    "ingestion": {
      "type": "object",
      "description": "Trace ingestion API configuration",
      "additionalProperties": true
    },
    "configStorage": {
      "type": "object",
      "description": "Configuration storage backend",
      "additionalProperties": true
    },
    "configManagement": {
      "type": "object",
      "description": "Config management server configuration",
      "additionalProperties": true
    },
    "environment": {
      "type": "string",
      "description": "Environment name (e.g., development, staging, production)",
      "enum": ["development", "staging", "production", "test"],
      "default": "development"
    },
    "projectId": {
      "type": "string",
      "description": "Project identifier for multi-project setups"
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata for the configuration",
      "additionalProperties": true
    }
  },
  "required": ["tracepoints"],
  "additionalProperties": false,
  "definitions": {
    "captureConfig": {
      "type": "object",
      "description": "Configuration for variable capture behavior",
      "properties": {
        "maxDepth": {
          "type": "integer",
          "description": "Maximum depth for capturing object properties",
          "default": 2,
          "minimum": 0
        },
        "maxArrayLength": {
          "type": "integer",
          "description": "Maximum number of array elements to capture",
          "default": 100,
          "minimum": 1
        },
        "maxCaptureSize": {
          "type": "integer",
          "description": "Maximum size in bytes for captured data",
          "default": 10240,
          "minimum": 1
        },
        "sensitivePatterns": {
          "type": "array",
          "description": "Patterns for sensitive fields that should be redacted",
          "items": {
            "type": "string"
          },
          "default": ["password", "secret", "token", "key", "auth"]
        },
        "captureThis": {
          "type": "boolean",
          "description": "Whether to capture the `this` context",
          "default": true
        },
        "redactionPlaceholder": {
          "type": "string",
          "description": "Redaction placeholder text",
          "default": "[REDACTED]"
        }
      },
      "additionalProperties": false
    },
    "tracepointDefinition": {
      "type": "object",
      "description": "Configuration for a single tracepoint with variable capture",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the tracepoint"
        },
        "type": {
          "type": "string",
          "description": "Type of injection point",
          "enum": ["before", "after", "entry", "exit"]
        },
        "lineNumber": {
          "type": "integer",
          "description": "Line number for before/after injections (1-indexed)",
          "minimum": 1
        },
        "functionName": {
          "type": "string",
          "description": "Function name or path for entry/exit injections"
        },
        "functionPath": {
          "type": "string",
          "description": "Function path for nested functions (e.g., ClassName.methodName)"
        },
        "captureExpressions": {
          "type": "array",
          "description": "List of variable names or expressions to capture",
          "items": {
            "type": "string",
            "pattern": "^[a-zA-Z_$][a-zA-Z0-9_$]*(\\.[a-zA-Z_$][a-zA-Z0-9_$]*|\\[\\d+\\]|\\[[a-zA-Z_$][a-zA-Z0-9_$]*\\])*$"
          }
        },
        "captureConfig": {
          "$ref": "#/definitions/captureConfig"
        },
        "includeAsync": {
          "type": "boolean",
          "description": "Whether to inject into async functions",
          "default": false
        },
        "includeGenerators": {
          "type": "boolean",
          "description": "Whether to inject into generator functions",
          "default": false
        },
        "description": {
          "type": "string",
          "description": "Description of this tracepoint"
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata for the tracepoint",
          "additionalProperties": true
        }
      },
      "required": ["id", "type"],
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "enum": ["before", "after"]
              }
            }
          },
          "then": {
            "required": ["lineNumber"]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "enum": ["entry", "exit"]
              }
            }
          },
          "then": {
            "anyOf": [
              { "required": ["functionName"] },
              { "required": ["functionPath"] }
            ]
          }
        }
      ]
    }
  }
}
